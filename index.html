<!DOCTYPE html>
<html>
  <head>
    <title>chess ordi</title>
  </head>
  <body>
    <p id="t">Loading...</p>
    <p id="n"></p>
    <p id="moves"></p>
    <div id="board"></div>

    <script type="module">
      import { Chess } from 'https://www.unpkg.com/chess.js@1.0.0-beta.6/dist/esm/chess.js'
      
      const apiUrl = 'https://ordinals.com'
      const query = new URLSearchParams(window.location.search).get('g')

      function getContentFromApi(contentUri) {
        return fetch(apiUrl + contentUri).then(r => r.json())
      }

      async function main() {
        const moves = [await getContentFromApi('/content/' + query)]
        while (moves[0].p !== 'chess') {
          moves.unshift(await getContentFromApi(moves[0].on))
        }

        const game = new Chess()

        for (const move of moves.slice(1)) {
          game.move(move.move)
        }

        document.getElementById('t').innerHTML = query
        document.getElementById('n').innerHTML = moves[moves.length-1].n
        document.getElementById('moves').innerHTML = game.history().join(',')

        const b = document.getElementById('board')

        const gameBoard = game.board()

        for (let r = 0; r < gameBoard.length; r++) {
          const rd = document.createElement('div')
          rd.setAttribute('style', 'display: flex; margin: 0;')
          for (let c = 0; c < gameBoard[r].length; c++) {
            const cd = document.createElement('div')
            cd.setAttribute('style', 'float: left; width: 45px; height: 45px;')
            const p = gameBoard[r][c]
            const i = document.createElement('img')
            if (p) {
              i.setAttribute('src', 'img/Chess_' + p.type + (p.color === 'w' ? 'l' : 'd') + (r % 2 + c % 2 === 1 ? 'd' : 'l') + '45.svg')
            } else {
              i.setAttribute('src', 'img/Chess_' + (r % 2 + c % 2 === 1 ? 'b' : 'l') + '.svg')
            }
            cd.append(i)
            rd.appendChild(cd)
          }
          b.appendChild(rd)
        }        
      }

      main().catch(e => document.getElementById('n').innerHTML = e.message)
    </script>
  </body>
</html>
